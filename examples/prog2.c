/*
 * prog.c: dosmc sample program
 * by ptss@fazekas.hu at Thu Jun 25 12:23:58 CEST 2020
 *
 * Compile to prog.exe: ./dosmc prog.c
 * Compile to prog.com: ./dosmc -bt=com prog.c
 * Run it with `dosbox .', then `prog.exe'.
 * Expected output: ZYfghiHello!
 */

#include <dosmc.h>

__LINKER_FLAG(start_es_psp)

/* Only with static, both get_str and the string literal will be optimized away. */
static char *example_get_str(void) {
  return "LONG STRING";
}

int double_int(int x) {
  return x * 2;
}

int add(int a, int b, int(*f)(int)) {
  return a + f(b);
}

unsigned fact(unsigned n) {
  unsigned result = 1;
  for (; n > 1; --n) {
    result *= n;
  }
  return result;
}

static int staticuninit;
static int staticinit = 44;

extern int myextern2;
// int myextern2;
extern char myextern1;
// char myextern1;

const int base = 2;
const char basex = 4;
const int basey = 5;

char hi[137], ho;
int answer;

#define DUP(a) a a
#define MUL256(a) DUP(DUP(DUP(DUP(DUP(DUP(DUP(DUP(a))))))))

int var1;
int var2;
int var3;
int var4;
int var5;
int var6;
int var7;
int var8;
int var9;
int var10;
int var11;
int var12;
int var13;
int var14;
int var15;
int var16;
int var17;
int var18;
int var19;
int var20;
int var21;
int var22;
int var23;
int var24;
int var25;
int var26;
int var27;
int var28;
int var29;
int var30;
int var31;
int var32;
int var33;
int var34;
int var35;
int var36;
int var37;
int var38;
int var39;
int var40;
int var41;
int var42;
int var43;
int var44;
int var45;
int var46;
int var47;
int var48;
int var49;
int var50;
int var51;
int var52;
int var53;
int var54;
int var55;
int var56;
int var57;
int var58;
int var59;
int var60;
int var61;
int var62;
int var63;
int var64;
int var65;
int var66;
int var67;
int var68;
int var69;
int var70;
int var71;
int var72;
int var73;
int var74;
int var75;
int var76;
int var77;
int var78;
int var79;
int var80;
int var81;
int var82;
int var83;
int var84;
int var85;
int var86;
int var87;
int var88;
int var89;
int var90;
int var91;
int var92;
int var93;
int var94;
int var95;
int var96;
int var97;
int var98;
int var99;
int var100;
int var101;
int var102;
int var103;
int var104;
int var105;
int var106;
int var107;
int var108;
int var109;
int var110;
int var111;
int var112;
int var113;
int var114;
int var115;
int var116;
int var117;
int var118;
int var119;
int var120;
int var121;
int var122;
int var123;
int var124;
int var125;
int var126;
int var127;
int var128;
int var129;
int var130;
int var131;
int var132;
int var133;
int var134;
int var135;
int var136;
int var137;
int var138;
int var139;
int var140;
int var141;
int var142;
int var143;
int var144;
int var145;
int var146;
int var147;
int var148;
int var149;
int var150;
int var151;
int var152;
int var153;
int var154;
int var155;
int var156;
int var157;
int var158;
int var159;
int var160;
int var161;
int var162;
int var163;
int var164;
int var165;
int var166;
int var167;
int var168;
int var169;
int var170;
int var171;
int var172;
int var173;
int var174;
int var175;
int var176;
int var177;
int var178;
int var179;
int var180;
int var181;
int var182;
int var183;
int var184;
int var185;
int var186;
int var187;
int var188;
int var189;
int var190;
int var191;
int var192;
int var193;
int var194;
int var195;
int var196;
int var197;
int var198;
int var199;
int var200;
int var201;
int var202;
int var203;
int var204;
int var205;
int var206;
int var207;
int var208;
int var209;
int var210;
int var211;
int var212;
int var213;
int var214;
int var215;
int var216;
int var217;
int var218;
int var219;
int var220;
int var221;
int var222;
int var223;
int var224;
int var225;
int var226;
int var227;
int var228;
int var229;
int var230;
int var231;
int var232;
int var233;
int var234;
int var235;
int var236;
int var237;
int var238;
int var239;
int var240;
int var241;
int var242;
int var243;
int var244;
int var245;
int var246;
int var247;
int var248;
int var249;
int var250;
int var251;
int var252;
int var253;
int var254;
int var255;
int var256;


int main(void) {
  char msg[3];
  msg[0] = 'Z'; msg[1] = 'Y'; msg[2] = '$';
  staticuninit = 12; // myextern1 = myextern2 = 13;
  _printmsgx(msg);
  /* !! prog.o (generated by the compiler contains WORD-aligned segments) */
  /* !! How to get command-line arguments? From PSP 0x80 -- or CMDLINE environment variable. */
  /* !! Initialize es in crt0? (cstrt086.asm doesn't do it) */
  /* !! Pack relocations, save 16 bytes. Maybe get rid of single relocation (mov ax, DGROUP)? */
  /* !! Remove single relocation (mov ax, DGROUP) */
  /* !! Why are strings aligned to 2? Is it segment alignment? */
  _printmsgx("abcdefghi$" + add(1, 2, double_int));  /* "fghi" */
  _printmsgx("++Hello!\r\n$" + base + answer);
  ++var1;
  ++var2;
  ++var3;
  ++var4;
  ++var5;
  ++var6;
  ++var7;
  ++var8;
  ++var9;
  ++var10;
  ++var11;
  ++var12;
  ++var13;
  ++var14;
  ++var15;
  ++var16;
  ++var17;
  ++var18;
  ++var19;
  ++var20;
  ++var21;
  ++var22;
  ++var23;
  ++var24;
  ++var25;
  ++var26;
  ++var27;
  ++var28;
  ++var29;
  ++var30;
  ++var31;
  ++var32;
  ++var33;
  ++var34;
  ++var35;
  ++var36;
  ++var37;
  ++var38;
  ++var39;
  ++var40;
  ++var41;
  ++var42;
  ++var43;
  ++var44;
  ++var45;
  ++var46;
  ++var47;
  ++var48;
  ++var49;
  ++var50;
  ++var51;
  ++var52;
  ++var53;
  ++var54;
  ++var55;
  ++var56;
  ++var57;
  ++var58;
  ++var59;
  ++var60;
  ++var61;
  ++var62;
  ++var63;
  ++var64;
  ++var65;
  ++var66;
  ++var67;
  ++var68;
  ++var69;
  ++var70;
  ++var71;
  ++var72;
  ++var73;
  ++var74;
  ++var75;
  ++var76;
  ++var77;
  ++var78;
  ++var79;
  ++var80;
  ++var81;
  ++var82;
  ++var83;
  ++var84;
  ++var85;
  ++var86;
  ++var87;
  ++var88;
  ++var89;
  ++var90;
  ++var91;
  ++var92;
  ++var93;
  ++var94;
  ++var95;
  ++var96;
  ++var97;
  ++var98;
  ++var99;
  ++var100;
  ++var101;
  ++var102;
  ++var103;
  ++var104;
  ++var105;
  ++var106;
  ++var107;
  ++var108;
  ++var109;
  ++var110;
  ++var111;
  ++var112;
  ++var113;
  ++var114;
  ++var115;
  ++var116;
  ++var117;
  ++var118;
  ++var119;
  ++var120;
  ++var121;
  ++var122;
  ++var123;
  ++var124;
  ++var125;
  ++var126;
  ++var127;
  ++var128;
  ++var129;
  ++var130;
  ++var131;
  ++var132;
  ++var133;
  ++var134;
  ++var135;
  ++var136;
  ++var137;
  ++var138;
  ++var139;
  ++var140;
  ++var141;
  ++var142;
  ++var143;
  ++var144;
  ++var145;
  ++var146;
  ++var147;
  ++var148;
  ++var149;
  ++var150;
  ++var151;
  ++var152;
  ++var153;
  ++var154;
  ++var155;
  ++var156;
  ++var157;
  ++var158;
  ++var159;
  ++var160;
  ++var161;
  ++var162;
  ++var163;
  ++var164;
  ++var165;
  ++var166;
  ++var167;
  ++var168;
  ++var169;
  ++var170;
  ++var171;
  ++var172;
  ++var173;
  ++var174;
  ++var175;
  ++var176;
  ++var177;
  ++var178;
  ++var179;
  ++var180;
  ++var181;
  ++var182;
  ++var183;
  ++var184;
  ++var185;
  ++var186;
  ++var187;
  ++var188;
  ++var189;
  ++var190;
  ++var191;
  ++var192;
  ++var193;
  ++var194;
  ++var195;
  ++var196;
  ++var197;
  ++var198;
  ++var199;
  ++var200;
  ++var201;
  ++var202;
  ++var203;
  ++var204;
  ++var205;
  ++var206;
  ++var207;
  ++var208;
  ++var209;
  ++var210;
  ++var211;
  ++var212;
  ++var213;
  ++var214;
  ++var215;
  ++var216;
  ++var217;
  ++var218;
  ++var219;
  ++var220;
  ++var221;
  ++var222;
  ++var223;
  ++var224;
  ++var225;
  ++var226;
  ++var227;
  ++var228;
  ++var229;
  ++var230;
  ++var231;
  ++var232;
  ++var233;
  ++var234;
  ++var235;
  ++var236;
  ++var237;
  ++var238;
  ++var239;
  ++var240;
  ++var241;
  ++var242;
  ++var243;
  ++var244;
  ++var245;
  ++var246;
  ++var247;
  ++var248;
  ++var249;
  ++var250;
  ++var251;
  ++var252;
  ++var253;
  ++var254;
  ++var255;
  ++var256;
  
  return add(7, 8, double_int);
}
